      SUBROUTINE ICECALC(IFW)
      ! APEX1905
      ! CORRECT VOLWC FOR FREEZING WHEN TEMPERATURE IS BELOW 0C.  ICE
      ! FRACTION IS ASSUMED TO BE A LINEAR RAMP BETWEEN 0C AND -8C.  WE
      ! SET A FLOOR OF 1.0E-8 ON THE RESIDUAL WATER FRACTION IN ORDER TO
      ! PREVENT DIVIDE-BY-ZERO PROBLEMS AND TO ENSURE THAT THIS FUNCTION
      ! IS INVERTIBLE.
      USE PARM
      DO J=1,NBCL
          IF(SOT(J,ISA)<0.)THEN
              ! SET A FLOOR ON FAC TO AVOID POSSIBLE DIVIDE-BY-ZERO AND TO ENSURE RELATION IS INVERTIBLE
              FAC=MAX(1.+.125*SOT(J,ISA),1.0E-8)
              IF(IFW==0)THEN
                  TPOR(J,ISA)=TPOR(J,ISA)-(1.-FAC)*VWC(J,ISA) ! REDUCE TOTAL POROSITY BY THE VOLUME OF THE ICE COMPONENT
                  VWC(J,ISA)=VWC(J,ISA)*FAC
              ELSE
                  VWC(J,ISA)=VWC(J,ISA)/FAC
                  TPOR(J,ISA)=TPOR(J,ISA)+(1.0-FAC)*VWC(J,ISA) ! ADD THE ICE BACK TO THE TOTAL
              END IF
          END IF    
      END DO
      RETURN
      END
